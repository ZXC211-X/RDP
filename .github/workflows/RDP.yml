name: RDP - Advanced Edition Clean

on:
  workflow_dispatch:
    inputs:
      storage_size:
        description: 'Storage Size (GB)'
        required: false
        default: '50'
      performance_mode:
        description: 'Performance Mode'
        required: false
        default: 'maximum'
        type: choice
        options:
          - balanced
          - maximum
          - gaming

jobs:
  advanced-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: "üîß Disable Unnecessary Services"
        run: |
          Write-Host "`nüîß Configuring System Services..." -ForegroundColor Cyan
          
          $disableServices = @("DiagTrack", "dmwappushservice", "HomeGroupListener", "HomeGroupProvider", "WSearch", "WMPNetworkSvc", "RemoteRegistry", "TabletInputService")
          
          foreach ($service in $disableServices) {
            $svc = Get-Service -Name $service -ErrorAction SilentlyContinue
            if ($svc) {
              Stop-Service -Name $service -Force -NoWait -ErrorAction SilentlyContinue
              Set-Service -Name $service -StartupType Disabled -ErrorAction SilentlyContinue
            }
          }
          
          Write-Host "  ‚úì Disabled $($disableServices.Count) services" -ForegroundColor Green
          
          echo "PERF_MODE=${{ github.event.inputs.performance_mode }}" >> $env:GITHUB_ENV
          echo "STORAGE_SIZE=${{ github.event.inputs.storage_size }}" >> $env:GITHUB_ENV

      - name: "‚ö° CPU Performance Tuning"
        run: |
          Write-Host "`n‚ö° CPU Optimization..." -ForegroundColor Yellow
          
          Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\PriorityControl' -Name "Win32PrioritySeparation" -Value 26 -Force
          powercfg /setactive 8c5e7fda-e8bf-45a6-a6cc-4b3c1f7e0330
          powercfg /change monitor-timeout-ac 0
          powercfg /change disk-timeout-ac 0
          
          Write-Host "  ‚úì CPU tuned for maximum performance" -ForegroundColor Green

      - name: "üíæ Memory Optimization"
        run: |
          Write-Host "`nüíæ Memory Optimization..." -ForegroundColor Yellow
          
          $memPath = 'HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management'
          Set-ItemProperty -Path $memPath -Name "LargeSystemCache" -Value 1 -Force
          Set-ItemProperty -Path $memPath -Name "PageFileExtensionSize" -Value 1024000 -Force
          Set-ItemProperty -Path $memPath -Name "IoPageLockLimit" -Value 16000000 -Force
          Set-ItemProperty -Path "$memPath\PrefetchParameters" -Name "EnablePrefetcher" -Value 3 -Force
          
          Write-Host "  ‚úì Memory optimized" -ForegroundColor Green

      - name: "üåê TCP Core Parameters"
        run: |
          Write-Host "`nüåê Network Stack (TCP Core)..." -ForegroundColor Cyan
          
          $tcpPath = 'HKLM:\SYSTEM\CurrentControlSet\Services\TCPIP\Parameters'
          Set-ItemProperty -Path $tcpPath -Name "TcpWindowSize" -Value 65535 -Force
          Set-ItemProperty -Path $tcpPath -Name "TcpMaxDataRetransmissions" -Value 5 -Force
          Set-ItemProperty -Path $tcpPath -Name "EnablePMTUDiscovery" -Value 1 -Force
          Set-ItemProperty -Path $tcpPath -Name "DefaultTTL" -Value 64 -Force
          Set-ItemProperty -Path $tcpPath -Name "Tcp1323Opts" -Value 1 -Force
          Set-ItemProperty -Path $tcpPath -Name "SackOpts" -Value 1 -Force
          Set-ItemProperty -Path $tcpPath -Name "TcpDelAckTicks" -Value 0 -Force
          Set-ItemProperty -Path $tcpPath -Name "TcpFACKEnabled" -Value 1 -Force
          
          Write-Host "  ‚úì TCP configured" -ForegroundColor Green

      - name: "üåê Network Adapter Optimization"
        run: |
          Write-Host "`nüåê Optimizing Network Adapters..." -ForegroundColor Cyan
          
          $adapters = Get-NetAdapter -Physical -ErrorAction SilentlyContinue
          if ($adapters.Count -gt 0) {
            foreach ($adapter in $adapters) {
              $props = Get-NetAdapterAdvancedProperty -Name $adapter.Name -ErrorAction SilentlyContinue
              
              if ($props | Where-Object { $_.RegistryKeyword -eq '*JumboPacket' }) {
                Set-NetAdapterAdvancedProperty -Name $adapter.Name -RegistryKeyword "*JumboPacket" -RegistryValue 9014 -ErrorAction SilentlyContinue
              }
              if ($props | Where-Object { $_.RegistryKeyword -eq '*RscIPv4' }) {
                Set-NetAdapterAdvancedProperty -Name $adapter.Name -RegistryKeyword "*RscIPv4" -RegistryValue 1 -ErrorAction SilentlyContinue
              }
              if ($props | Where-Object { $_.RegistryKeyword -eq '*LsoV2IPv4' }) {
                Set-NetAdapterAdvancedProperty -Name $adapter.Name -RegistryKeyword "*LsoV2IPv4" -RegistryValue 1 -ErrorAction SilentlyContinue
              }
            }
            Write-Host "  ‚úì Network Adapters optimized" -ForegroundColor Green
          }

      - name: "üåê netsh TCP Configuration"
        run: |
          Write-Host "`nüåê netsh TCP Settings..." -ForegroundColor Cyan
          
          netsh int tcp set global rss=enabled
          netsh int tcp set global autotuninglevel=normal
          netsh int tcp set global ecncapability=enabled
          netsh int tcp set global timestamps=enabled
          netsh int tcp set global initialrto=1000
          netsh int tcp set global rsc=enabled
          netsh int tcp set global fastopen=enabled
          
          Write-Host "  ‚úì netsh configured" -ForegroundColor Green

      - name: "üåê Advanced TCP Registry"
        run: |
          Write-Host "`nüåê Advanced TCP Registry..." -ForegroundColor Cyan
          
          $tcpPath = 'HKLM:\SYSTEM\CurrentControlSet\Services\TCPIP\Parameters'
          Set-ItemProperty -Path $tcpPath -Name "EnableTCPA" -Value 1 -Force
          Set-ItemProperty -Path $tcpPath -Name "EnableNetDMA" -Value 1 -Force
          Set-ItemProperty -Path $tcpPath -Name "EnableDynamicThrottling" -Value 1 -Force
          Set-ItemProperty -Path $tcpPath -Name "InitialRto" -Value 1000 -Force
          Set-ItemProperty -Path $tcpPath -Name "MinRto" -Value 300 -Force
          Set-ItemProperty -Path $tcpPath -Name "MaxRto" -Value 20000 -Force
          
          $procCount = (Get-WmiObject -Class Win32_Processor).NumberOfLogicalProcessors
          Set-ItemProperty -Path $tcpPath -Name "MaxProcessors" -Value $procCount -Force
          
          Write-Host "  ‚úì Advanced TCP set" -ForegroundColor Green

      - name: "üåê IPv6 Configuration"
        run: |
          Write-Host "`nüåê IPv6 Optimization..." -ForegroundColor Cyan
          
          $ipv6Path = 'HKLM:\SYSTEM\CurrentControlSet\Services\TCPIP6\Parameters'
          Set-ItemProperty -Path $ipv6Path -Name "DefaultHopLimit" -Value 64 -Force
          Set-ItemProperty -Path $ipv6Path -Name "ReassemblyLimit" -Value 9999999 -Force
          
          Write-Host "  ‚úì IPv6 optimized" -ForegroundColor Green

      - name: "üåê DNS Configuration"
        run: |
          Write-Host "`nüåê DNS..." -ForegroundColor Cyan
          Clear-DnsClientCache -ErrorAction SilentlyContinue
          Write-Host "  ‚úì DNS Cache cleared" -ForegroundColor Green

      - name: "üåê QoS Configuration"
        run: |
          Write-Host "`nüåê QoS Setup..." -ForegroundColor Cyan
          
          Get-NetQosPolicy -ErrorAction SilentlyContinue | Remove-NetQosPolicy -Confirm:$false -ErrorAction SilentlyContinue
          New-NetQosPolicy -Name "RDP-Priority" -IPProtocol TCP -IPPort 3389 -PolicyStore ActiveStore -Precedence 1 -ThrottleRateActionBitsPerSecond 0 -ErrorAction SilentlyContinue
          New-NetQosPolicy -Name "Audio-Priority" -IPProtocol UDP -IPPort 1194-1300 -PolicyStore ActiveStore -Precedence 2 -ThrottleRateActionBitsPerSecond 0 -ErrorAction SilentlyContinue
          
          Write-Host "  ‚úì QoS configured" -ForegroundColor Green

      - name: "üéÆ GPU Acceleration"
        run: |
          Write-Host "`nüéÆ GPU Acceleration Setup..." -ForegroundColor Magenta
          
          $gpuPath = 'HKLM:\SYSTEM\CurrentControlSet\Control\GraphicsDrivers'
          if (-not (Test-Path $gpuPath)) { New-Item -Path $gpuPath -Force | Out-Null }
          
          Set-ItemProperty -Path $gpuPath -Name "HwSchMode" -Value 2 -Force
          
          $watchdogPath = "$gpuPath\Watchdog"
          if (-not (Test-Path $watchdogPath)) { New-Item -Path $watchdogPath -Force | Out-Null }
          Set-ItemProperty -Path $watchdogPath -Name "Level" -Value 0 -Force
          
          Write-Host "  ‚úì GPU acceleration enabled" -ForegroundColor Green

      - name: "üë§ Create RDP User"
        run: |
          Write-Host "`nüë§ Creating RDP user..." -ForegroundColor Cyan
          
          try {
            $password = -join ((48..57) + (65..90) + (97..122) | Get-Random -Count 16 | ForEach-Object {[char]$_})
            
            Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue | Remove-LocalUser -Force -ErrorAction SilentlyContinue
            
            $securePass = ConvertTo-SecureString $password -AsPlainText -Force
            New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires -PasswordNeverExpires: $true
            Add-LocalGroupMember -Group "Administrators" -Member "RDP"
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
            
            echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
            Write-Host "  ‚úì RDP user created" -ForegroundColor Green
          } catch {
            Write-Host "  ‚úó RDP user failed:  $_" -ForegroundColor Red
            exit 1
          }

      - name: "üìÇ Create Storage Drive"
        run: |
          Write-Host "`nüìÇ Creating storage..." -ForegroundColor Yellow
          
          try {
            $size = [int]$env:STORAGE_SIZE * 1GB
            if ($size -lt 1GB) { $size = 50GB }
            
            # Use temp drive D: which usually has ~14GB free, or C: if small
            # Github Actions free runners have limited space.
            $vhdxPath = "C:\data_drive.vhdx"
            
            New-VHD -Path $vhdxPath -SizeBytes $size -Dynamic -ErrorAction SilentlyContinue | Out-Null
            $vhd = Mount-VHD -Path $vhdxPath -PassThru
            
            Start-Sleep -Seconds 3
            
            $disk = $vhd | Get-Disk
            $disk | Initialize-Disk -PartitionStyle GPT -PassThru | Out-Null
            $partition = $disk | New-Partition -AssignDriveLetter -UseMaximumSize
            $partition | Format-Volume -FileSystem NTFS -NewFileSystemLabel "DataDrive" -Confirm:$false -Force | Out-Null
            
            $driveLetter = $partition.DriveLetter
            echo "DATA_DRIVE=${driveLetter}:" >> $env:GITHUB_ENV
            
            Write-Host "  ‚úì Storage:  ${driveLetter}:  ($env:STORAGE_SIZE GB)" -ForegroundColor Green
          } catch {
            Write-Host "  ‚ö†Ô∏è Storage:  Could not create VHD (Likely insufficient space or permission)" -ForegroundColor Yellow
            Write-Host "  Error: $_" -ForegroundColor Red
          }

      - name: "üîß Configure RDP"
        run: |
          Write-Host "`nüîß RDP Configuration..." -ForegroundColor Cyan
          
          $regPath = 'HKLM:\System\CurrentControlSet\Control\Terminal Server'
          $rdpPath = "$regPath\WinStations\RDP-Tcp"
          
          Set-ItemProperty -Path $regPath -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path $rdpPath -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path $rdpPath -Name "SecurityLayer" -Value 0 -Force
          Set-ItemProperty -Path $rdpPath -Name "MaxIdleTime" -Value 0 -Force
          Set-ItemProperty -Path $rdpPath -Name "fDisableUdpTransport" -Value 0 -Force
          Set-ItemProperty -Path $rdpPath -Name "fEnableWddmDriver" -Value 1 -Force
          Set-ItemProperty -Path $rdpPath -Name "ColorDepth" -Value 4 -Force
          Set-ItemProperty -Path $rdpPath -Name "fMultiMonitorSupport" -Value 1 -Force
          
          Restart-Service -Name TermService -Force
          Start-Sleep -Seconds 3
          
          Write-Host "  ‚úì RDP configured" -ForegroundColor Green

      - name: "üîå Install Tailscale"
        run: |
          Write-Host "`nüîå Installing Tailscale..." -ForegroundColor Magenta
          
          try {
            $stablePage = Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/" -UseBasicParsing -TimeoutSec 15
            $msiUrl = ($stablePage.Links | Where-Object { $_.href -like "*amd64.msi" } | Select-Object -First 1).href
            if (-not $msiUrl.StartsWith("http")) { $msiUrl = "https://pkgs.tailscale.com/stable/$msiUrl" }
            
            $installerPath = "$env:TEMP\tailscale.msi"
            Invoke-WebRequest -Uri $msiUrl -OutFile $installerPath -TimeoutSec 120
            
            Start-Process msiexec.exe -ArgumentList "/i", "$installerPath", "/quiet", "/norestart" -Wait
            Remove-Item $installerPath -Force
            
            Write-Host "  ‚úì Tailscale installed" -ForegroundColor Green
          } catch {
            Write-Host "  ‚úó Tailscale failed:  $_" -ForegroundColor Red
            exit 1
          }

      - name: "üîí Configure Firewall"
        run: |
          Write-Host "`nüîí Firewall..." -ForegroundColor Cyan
          
          netsh advfirewall firewall delete rule name="RDP-Tailscale" 2>$null
          netsh advfirewall firewall delete rule name="Audio-RDP" 2>$null
          
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389 remoteip=100.64.0.0/10 enable=yes
          netsh advfirewall firewall add rule name="Audio-RDP" dir=in action=allow protocol=UDP localport=1194-1300 remoteip=100.64.0.0/10 enable=yes
          
          Write-Host "  ‚úì Firewall configured" -ForegroundColor Green

      - name: "üåç Connect Tailscale"
        run:  |
          Write-Host "`nüåç Connecting Tailscale..." -ForegroundColor Magenta
          
          try {
            & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-rdp-${{ github.run_id }} --accept-routes --accept-dns=false
            
            $retries = 0
            $tsIP = $null
            while ($retries -lt 25 -and -not $tsIP) {
              Start-Sleep -Seconds 2
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
              $retries++
            }
            
            if (-not $tsIP) { throw "No Tailscale IP" }
            echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
            Write-Host "  ‚úì Connected:  $tsIP" -ForegroundColor Green
          } catch {
            Write-Host "  ‚úó Tailscale failed: $_" -ForegroundColor Red
            exit 1
          }

      - name: "üìã Display Connection Info"
        run: |
          Write-Host "`n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
          Write-Host "‚ïë        üöÄ RDP CONNECTION INFORMATION üöÄ       ‚ïë" -ForegroundColor Cyan
          Write-Host "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" -ForegroundColor Cyan
          Write-Host "‚ïë  üåç IP:        $env:TAILSCALE_IP" -ForegroundColor Green
          Write-Host "‚ïë  üë§ User:      RDP" -ForegroundColor Green
          Write-Host "‚ïë  üîë Pass:      $env:RDP_PASSWORD" -ForegroundColor Yellow
          if ($env:DATA_DRIVE) {
          Write-Host "‚ïë  üíæ Storage:   $env:DATA_DRIVE ($env:STORAGE_SIZE GB)" -ForegroundColor Green
          }
          Write-Host "‚ïë  ‚öôÔ∏è  Mode:      $env:PERF_MODE" -ForegroundColor Cyan
          Write-Host "‚ïë" -ForegroundColor Cyan
          Write-Host "‚ïë  üì£ Audio Setup:" -ForegroundColor Magenta
          Write-Host "‚ïë  RDP > Local Resources > Remote Audio > Play on this computer" -ForegroundColor Gray
          Write-Host "‚ïë" -ForegroundColor Cyan
          Write-Host "‚ïë  ‚ú® Optimizations Applied:" -ForegroundColor Green
          Write-Host "‚ïë  ‚úì CPU ‚úì Memory ‚úì Network ‚úì GPU ‚úì QoS ‚úì Firewall" -ForegroundColor Gray
          Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan

      - name: "‚è≥ Monitor & Keep-Alive"
        run: |
          Write-Host "`n‚è≥ Monitoring started..." -ForegroundColor Green
          
          $sessionActive = $true
          while ($sessionActive) {
            try {
              $timestamp = Get-Date -Format "HH:mm:ss"
              $tsStatus = & "$env:ProgramFiles\Tailscale\tailscale.exe" status 2>$null | Select-Object -First 1
              if ($tsStatus -match "Connected") {
                $cpuUsage = (Get-WmiObject -Query "SELECT LoadPercentage FROM Win32_Processor" | Measure-Object -Property LoadPercentage -Average).Average
                Write-Host "[$timestamp] ‚úÖ Connected | CPU: $([math]::Round($cpuUsage))%" -ForegroundColor Green
              } else {
                Write-Host "[$timestamp] ‚ö†Ô∏è Reconnecting..." -ForegroundColor Yellow
                & "$env:ProgramFiles\Tailscale\tailscale.exe" up --accept-routes --accept-dns=false
              }
              Start-Sleep -Seconds 60
            } catch {
              Write-Host "Error:  $_" -ForegroundColor Red
              Start-Sleep -Seconds 60
            }
          }
