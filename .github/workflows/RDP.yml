name: RDP - Advanced Edition Final

on:
  workflow_dispatch: 
    inputs:
      storage_size:
        description: 'Storage Size (GB)'
        required: false
        default: '500'
      performance_mode:
        description: 'Performance Mode'
        required: false
        default: 'maximum'
        type: choice
        options:
          - balanced
          - maximum
          - gaming

jobs:
  advanced-rdp: 
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: "ðŸ”§ Disable Unnecessary Services"
        run: |
          Write-Host "`nðŸ”§ Configuring System Services..." -ForegroundColor Cyan
          
          $disableServices = @(
              "DiagTrack", "dmwappushservice", "HomeGroupListener", "HomeGroupProvider",
              "WSearch", "WMPNetworkSvc", "RemoteRegistry", "TabletInputService"
          )
          
          foreach ($service in $disableServices) {
              $svc = Get-Service -Name $service -ErrorAction SilentlyContinue
              if ($svc) {
                  Stop-Service -Name $service -Force -NoWait -ErrorAction SilentlyContinue
                  Set-Service -Name $service -StartupType Disabled -ErrorAction SilentlyContinue
              }
          }
          
          Write-Host "  âœ“ Disabled $($disableServices.Count) unnecessary services" -ForegroundColor Green
          
          echo "PERF_MODE=${{ github.event.inputs.performance_mode }}" >> $env:GITHUB_ENV
          echo "STORAGE_SIZE=${{ github.event.inputs.storage_size }}" >> $env:GITHUB_ENV

      - name: "âš¡ CPU Performance Tuning"
        run: |
          Write-Host "`nâš¡ CPU & Process Optimization..." -ForegroundColor Yellow
          
          Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\PriorityControl' -Name "Win32PrioritySeparation" -Value 26 -Force
          
          powercfg /setactive 8c5e7fda-e8bf-45a6-a6cc-4b3c1f7e0330
          powercfg /change monitor-timeout-ac 0
          powercfg /change disk-timeout-ac 0
          powercfg /change standby-timeout-ac 0
          powercfg /change hibernate-timeout-ac 0
          
          Write-Host "  âœ“ CPU tuned for maximum performance" -ForegroundColor Green

      - name: "ðŸ’¾ Memory Optimization"
        run: |
          Write-Host "`nðŸ’¾ Memory Optimization..." -ForegroundColor Yellow
          
          $memPath = 'HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management'
          
          Set-ItemProperty -Path $memPath -Name "LargeSystemCache" -Value 1 -Force
          Set-ItemProperty -Path $memPath -Name "PageFileExtensionSize" -Value 1024000 -Force
          Set-ItemProperty -Path $memPath -Name "IoPageLockLimit" -Value 16000000 -Force
          Set-ItemProperty -Path "$memPath\PrefetchParameters" -Name "EnablePrefetcher" -Value 3 -Force
          Set-ItemProperty -Path "$memPath\PrefetchParameters" -Name "EnableSuperfetch" -Value 3 -Force
          
          Write-Host "  âœ“ Memory management optimized" -ForegroundColor Green

      - name: "ðŸŒ TCP Core Parameters"
        run: |
          Write-Host "`nðŸŒ Network Stack Optimization (TCP Core)..." -ForegroundColor Cyan
          
          $tcpPath = 'HKLM:\SYSTEM\CurrentControlSet\Services\TCPIP\Parameters'
          
          Set-ItemProperty -Path $tcpPath -Name "TcpWindowSize" -Value 65535 -Force
          Set-ItemProperty -Path $tcpPath -Name "TcpMaxDataRetransmissions" -Value 5 -Force
          Set-ItemProperty -Path $tcpPath -Name "EnablePMTUDiscovery" -Value 1 -Force
          Set-ItemProperty -Path $tcpPath -Name "DefaultTTL" -Value 64 -Force
          Set-ItemProperty -Path $tcpPath -Name "Tcp1323Opts" -Value 1 -Force
          Set-ItemProperty -Path $tcpPath -Name "SackOpts" -Value 1 -Force
          Set-ItemProperty -Path $tcpPath -Name "TcpDelAckTicks" -Value 0 -Force
          Set-ItemProperty -Path $tcpPath -Name "TcpFACKEnabled" -Value 1 -Force
          
          Write-Host "    âœ“ TCP Window Size: 65535" -ForegroundColor Green
          Write-Host "    âœ“ SACK: Enabled" -ForegroundColor Green
          Write-Host "    âœ“ TCP Timestamps: Enabled" -ForegroundColor Green
          Write-Host "  âœ“ TCP Core Parameters configured" -ForegroundColor Green

      - name: "ðŸŒ Network Adapter Optimization"
        run: |
          Write-Host "`nðŸŒ Optimizing Network Adapters..." -ForegroundColor Cyan
          
          $adapters = Get-NetAdapter -Physical -ErrorAction SilentlyContinue
          
          if ($adapters. Count -eq 0) {
              Write-Host "  âš  No physical adapters found" -ForegroundColor Yellow
          } else {
              foreach ($adapter in $adapters) {
                  Write-Host "  ðŸ“¡ $($adapter.Name)" -ForegroundColor Gray
                  
                  $props = Get-NetAdapterAdvancedProperty -Name $adapter.Name -ErrorAction SilentlyContinue
                  
                  if ($props | Where-Object { $_. RegistryKeyword -eq '*JumboPacket' }) {
                      Set-NetAdapterAdvancedProperty -Name $adapter.Name -RegistryKeyword "*JumboPacket" -RegistryValue 9014 -ErrorAction SilentlyContinue
                  }
                  
                  if ($props | Where-Object { $_.RegistryKeyword -eq '*RscIPv4' }) {
                      Set-NetAdapterAdvancedProperty -Name $adapter.Name -RegistryKeyword "*RscIPv4" -RegistryValue 1 -ErrorAction SilentlyContinue
                  }
                  
                  if ($props | Where-Object { $_. RegistryKeyword -eq '*LsoV2IPv4' }) {
                      Set-NetAdapterAdvancedProperty -Name $adapter.Name -RegistryKeyword "*LsoV2IPv4" -RegistryValue 1 -ErrorAction SilentlyContinue
                  }
                  
                  if ($props | Where-Object { $_.RegistryKeyword -eq '*LsoV2IPv6' }) {
                      Set-NetAdapterAdvancedProperty -Name $adapter.Name -RegistryKeyword "*LsoV2IPv6" -RegistryValue 1 -ErrorAction SilentlyContinue
                  }
                  
                  if ($props | Where-Object { $_.RegistryKeyword -eq '*TcpChecksumOffloadIPv4' }) {
                      Set-NetAdapterAdvancedProperty -Name $adapter.Name -RegistryKeyword "*TcpChecksumOffloadIPv4" -RegistryValue 3 -ErrorAction SilentlyContinue
                  }
                  
                  if ($props | Where-Object { $_. RegistryKeyword -eq '*TCPChecksumOffloadIPv6' }) {
                      Set-NetAdapterAdvancedProperty -Name $adapter.Name -RegistryKeyword "*TCPChecksumOffloadIPv6" -RegistryValue 3 -ErrorAction SilentlyContinue
                  }
                  
                  if ($props | Where-Object { $_.RegistryKeyword -eq '*UDPChecksumOffloadIPv4' }) {
                      Set-NetAdapterAdvancedProperty -Name $adapter.Name -RegistryKeyword "*UDPChecksumOffloadIPv4" -RegistryValue 3 -ErrorAction SilentlyContinue
                  }
                  
                  if ($props | Where-Object { $_. RegistryKeyword -eq '*UDPChecksumOffloadIPv6' }) {
                      Set-NetAdapterAdvancedProperty -Name $adapter.Name -RegistryKeyword "*UDPChecksumOffloadIPv6" -RegistryValue 3 -ErrorAction SilentlyContinue
                  }
              }
          }
          
          Write-Host "  âœ“ Network Adapters optimized" -ForegroundColor Green

      - name: "ðŸŒ netsh TCP Configuration"
        run: |
          Write-Host "`nðŸŒ Applying netsh TCP Settings..." -ForegroundColor Cyan
          
          netsh int tcp set global rss=enabled
          netsh int tcp set global autotuninglevel=normal
          netsh int tcp set global ecncapability=enabled
          netsh int tcp set global timestamps=enabled
          netsh int tcp set global initialrto=1000
          netsh int tcp set global rsc=enabled
          netsh int tcp set global fastopen=enabled
          netsh int tcp set global fastopenfallback=enabled
          netsh int tcp set global hystart=enabled
          netsh int tcp set global prr=enabled
          
          Write-Host "  âœ“ RSS, ECN, Fast Open, RSC enabled" -ForegroundColor Green
          Write-Host "  âœ“ netsh TCP configuration applied" -ForegroundColor Green

      - name:  "ðŸŒ Advanced TCP Registry"
        run: |
          Write-Host "`nðŸŒ Advanced TCP Registry Settings..." -ForegroundColor Cyan
          
          $tcpPath = 'HKLM:\SYSTEM\CurrentControlSet\Services\TCPIP\Parameters'
          
          Set-ItemProperty -Path $tcpPath -Name "EnableTCPA" -Value 1 -Force
          Set-ItemProperty -Path $tcpPath -Name "EnableNetDMA" -Value 1 -Force
          Set-ItemProperty -Path $tcpPath -Name "EnableDynamicThrottling" -Value 1 -Force
          Set-ItemProperty -Path $tcpPath -Name "InitialRto" -Value 1000 -Force
          Set-ItemProperty -Path $tcpPath -Name "MinRto" -Value 300 -Force
          Set-ItemProperty -Path $tcpPath -Name "MaxRto" -Value 20000 -Force
          Set-ItemProperty -Path $tcpPath -Name "RSSBaseProc" -Value 0 -Force
          
          $procCount = (Get-WmiObject -Class Win32_Processor).NumberOfLogicalProcessors
          Set-ItemProperty -Path $tcpPath -Name "MaxProcessors" -Value $procCount -Force
          
          Set-ItemProperty -Path $tcpPath -Name "SynAttackProtect" -Value 2 -Force
          Set-ItemProperty -Path $tcpPath -Name "KeepAliveInterval" -Value 7200000 -Force
          Set-ItemProperty -Path $tcpPath -Name "DeadGWDetectDefault" -Value 1 -Force
          Set-ItemProperty -Path $tcpPath -Name "MaxUserPort" -Value 65534 -Force
          Set-ItemProperty -Path $tcpPath -Name "TcpTimedWaitDelay" -Value 30 -Force
          
          Write-Host "  âœ“ Chimney, NetDMA, Dynamic Throttling enabled" -ForegroundColor Green
          Write-Host "  âœ“ RSS processors:  $procCount" -ForegroundColor Green
          Write-Host "  âœ“ Advanced registry tuning completed" -ForegroundColor Green

      - name: "ðŸŒ IPv6 Configuration"
        run:  |
          Write-Host "`nðŸŒ IPv6 Optimization..." -ForegroundColor Cyan
          
          $ipv6Path = 'HKLM:\SYSTEM\CurrentControlSet\Services\TCPIP6\Parameters'
          
          Set-ItemProperty -Path $ipv6Path -Name "DefaultHopLimit" -Value 64 -Force
          Set-ItemProperty -Path $ipv6Path -Name "ReassemblyLimit" -Value 9999999 -Force
          Set-ItemProperty -Path $ipv6Path -Name "IsatapRandomID" -Value 1 -Force
          
          Write-Host "  âœ“ IPv6 optimization completed" -ForegroundColor Green

      - name: "ðŸŒ DNS Configuration"
        run: |
          Write-Host "`nðŸŒ DNS Optimization..." -ForegroundColor Cyan
          
          try {
              Clear-DnsClientCache -ErrorAction SilentlyContinue
              Write-Host "  âœ“ DNS Cache cleared" -ForegroundColor Green
          } catch {
              Write-Host "  â„¹ DNS cache (non-critical)" -ForegroundColor Gray
          }

      - name: "ðŸŒ QoS Configuration"
        run:  |
          Write-Host "`nðŸŒ QoS Setup..." -ForegroundColor Cyan
          
          try {
              Get-NetQosPolicy -ErrorAction SilentlyContinue | Remove-NetQosPolicy -Confirm:$false -ErrorAction SilentlyContinue
              
              New-NetQosPolicy -Name "RDP-Priority" -IPProtocol TCP -IPPort 3389 -PolicyStore ActiveStore -Precedence 1 -ThrottleRateActionBitsPerSecond 0 -ErrorAction SilentlyContinue
              New-NetQosPolicy -Name "Audio-Priority" -IPProtocol UDP -IPPort 1194-1300 -PolicyStore ActiveStore -Precedence 2 -ThrottleRateActionBitsPerSecond 0 -ErrorAction SilentlyContinue
              
              Write-Host "  âœ“ QoS policies created" -ForegroundColor Green
          } catch {
              Write-Host "  âš  QoS policies (non-critical)" -ForegroundColor Yellow
          }

      - name: "ðŸŽ® GPU Acceleration Setup"
        run: |
          Write-Host "`nðŸŽ® GPU Acceleration Setup..." -ForegroundColor Magenta
          
          try {
              $gpuPath = 'HKLM:\SYSTEM\CurrentControlSet\Control\GraphicsDrivers'
              
              if (-not (Test-Path $gpuPath)) {
                  New-Item -Path $gpuPath -Force | Out-Null
              }
              
              Set-ItemProperty -Path $gpuPath -Name "HwSchMode" -Value 2 -Force
              
              $watchdogPath = "$gpuPath\Watchdog"
              if (-not (Test-Path $watchdogPath)) {
                  New-Item -Path $watchdogPath -Force | Out-Null
              }
              Set-ItemProperty -Path $watchdogPath -Name "Level" -Value 0 -Force
              
              Set-ItemProperty -Path $gpuPath -Name "EnableMiracast" -Value 2 -Force
              
              Write-Host "  âœ“ GPU acceleration enabled" -ForegroundColor Green
          } catch {
              Write-Host "  âš  GPU optimization (non-critical)" -ForegroundColor Yellow
          }

      - name: "ðŸ‘¤ Create RDP User"
        run: |
          Write-Host "`nðŸ‘¤ Creating RDP user..." -ForegroundColor Cyan
          
          try {
              $bytes = New-Object byte[] 40
              [System.Security. Cryptography.RNGCryptoServiceProvider]:: new().GetBytes($bytes)
              $password = [System.Convert]::ToBase64String($bytes).Substring(0, 48)
              
              Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue | Remove-LocalUser -Force -ErrorAction SilentlyContinue
              
              $securePass = ConvertTo-SecureString $password -AsPlainText -Force
              New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires -PasswordNeverExpires: $true -ErrorAction Stop
              Add-LocalGroupMember -Group "Administrators" -Member "RDP" -ErrorAction SilentlyContinue
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP" -ErrorAction SilentlyContinue
              
              echo "RDP_PASSWORD=$password" >> $env: GITHUB_ENV
              
              Write-Host "  âœ“ RDP user created" -ForegroundColor Green
          } catch {
              Write-Error "RDP user failed: $_"
              exit 1
          }

      - name: "ðŸ—‚ Create Storage Drive"
        run: |
          Write-Host "`nðŸ—‚ Creating storage drive..." -ForegroundColor Yellow
          
          try {
              $size = [int]$env:STORAGE_SIZE * 1GB
              $vhdxPath = "D:\data_drive.vhdx"
              
              New-VHD -Path $vhdxPath -SizeBytes $size -Fixed -ErrorAction Stop | Mount-VHD -PassThru | Out-Null
              Start-Sleep -Seconds 3
              
              $rawDisk = Get-Disk | Where-Object PartitionStyle -eq 'RAW' | Select-Object -First 1
              if ($rawDisk) {
                  $disk = $rawDisk | Initialize-Disk -PartitionStyle GPT -PassThru
                  $partition = $disk | New-Partition -AssignDriveLetter -UseMaximumSize
                  $partition | Format-Volume -FileSystem ReFS -NewFileSystemLabel "DataDrive" -Confirm:$false -Force | Out-Null
                  
                  $driveLetter = $partition.DriveLetter
                  echo "DATA_DRIVE=${driveLetter}:" >> $env:GITHUB_ENV
                  
                  Write-Host "  âœ“ Storage:  ${driveLetter}:  ($env:STORAGE_SIZE GB ReFS)" -ForegroundColor Green
              }
          } catch {
              Write-Host "  âš  Storage creation (non-critical)" -ForegroundColor Yellow
          }

      - name: "ðŸ”§ Configure RDP Settings"
        run: |
          Write-Host "`nðŸ”§ RDP Configuration..." -ForegroundColor Cyan
          
          $regPath = 'HKLM:\System\CurrentControlSet\Control\Terminal Server'
          $rdpPath = "$regPath\WinStations\RDP-Tcp"
          
          Set-ItemProperty -Path $regPath -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path $rdpPath -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path $rdpPath -Name "SecurityLayer" -Value 0 -Force
          Set-ItemProperty -Path $rdpPath -Name "MaxIdleTime" -Value 0 -Force
          Set-ItemProperty -Path $rdpPath -Name "MaxConnectionTime" -Value 0 -Force
          Set-ItemProperty -Path $rdpPath -Name "MaxDisconnectionTime" -Value 0 -Force
          Set-ItemProperty -Path $rdpPath -Name "fInheritMaxIdleTime" -Value 0 -Force
          Set-ItemProperty -Path $rdpPath -Name "fDisableUdpTransport" -Value 0 -Force
          Set-ItemProperty -Path $rdpPath -Name "fEnableWddmDriver" -Value 1 -Force
          Set-ItemProperty -Path $rdpPath -Name "fDisableAutoReconnect" -Value 0 -Force
          Set-ItemProperty -Path $rdpPath -Name "PerSessionBandwidthLimit" -Value 0 -Force
          Set-ItemProperty -Path $rdpPath -Name "ColorDepth" -Value 4 -Force
          Set-ItemProperty -Path $rdpPath -Name "fDisableCpm" -Value 0 -Force
          Set-ItemProperty -Path $rdpPath -Name "fDisableAudioCapture" -Value 0 -Force
          Set-ItemProperty -Path $rdpPath -Name "fDisableCdm" -Value 0 -Force
          Set-ItemProperty -Path $rdpPath -Name "fDisableLPT" -Value 1 -Force
          Set-ItemProperty -Path $rdpPath -Name "fDisablePNPRedir" -Value 1 -Force
          Set-ItemProperty -Path $rdpPath -Name "fDisablePrinting" -Value 1 -Force
          Set-ItemProperty -Path $rdpPath -Name "fMultiMonitorSupport" -Value 1 -Force
          
          Restart-Service -Name TermService -Force
          Start-Sleep -Seconds 3
          
          Write-Host "  âœ“ RDP configured and restarted" -ForegroundColor Green

      - name: "ðŸ”Œ Install Tailscale"
        run: |
          Write-Host "`nðŸ”Œ Installing Tailscale..." -ForegroundColor Magenta
          
          try {
              $stablePage = Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/" -UseBasicParsing -TimeoutSec 15
              $msiUrl = ($stablePage.Links | Where-Object { $_.href -like "*amd64.msi" } | Select-Object -First 1).href
              
              if (-not $msiUrl. StartsWith("http")) { 
                  $msiUrl = "https://pkgs.tailscale.com/stable/$msiUrl" 
              }
              
              $installerPath = "$env:TEMP\tailscale. msi"
              Invoke-WebRequest -Uri $msiUrl -OutFile $installerPath -TimeoutSec 30 -ErrorAction Stop
              Start-Process msiexec. exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait -ErrorAction Stop
              Remove-Item $installerPath -Force
              
              Write-Host "  âœ“ Tailscale installed" -ForegroundColor Green
          } catch {
              Write-Error "Tailscale installation failed:  $_"
              exit 1
          }

      - name: "ðŸ”’ Configure Firewall"
        run: |
          Write-Host "`nðŸ”’ Firewall Configuration..." -ForegroundColor Cyan
          
          netsh advfirewall firewall delete rule name="RDP-Tailscale" 2>$null
          netsh advfirewall firewall delete rule name="Audio-RDP" 2>$null
          netsh advfirewall firewall delete rule name="Tailscale-Full" 2>$null
          
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389 remoteip=100.64.0.0/10 enable=yes
          netsh advfirewall firewall add rule name="Audio-RDP" dir=in action=allow protocol=UDP localport=1194-1300 remoteip=100.64.0.0/10 enable=yes
          netsh advfirewall firewall add rule name="Tailscale-Full" dir=in action=allow remoteip=100.64.0.0/10 enable=yes
          
          Write-Host "  âœ“ Firewall rules configured" -ForegroundColor Green

      - name: "ðŸŒ Connect Tailscale"
        run:  |
          Write-Host "`nðŸŒ Connecting Tailscale..." -ForegroundColor Magenta
          
          try {
              & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-rdp-${{ github.run_id }} --accept-routes --accept-dns=false --speed-test=false
              
              $retries = 0
              $tsIP = $null
              while ($retries -lt 25 -and -not $tsIP) {
                  Start-Sleep -Seconds 2
                  $tsIP = & "$env:ProgramFiles\Tailscale\tailscale. exe" ip -4 2>$null
                  $retries++
              }
              
              if (-not $tsIP) {
                  throw "Could not obtain Tailscale IP"
              }
              
              echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
              Write-Host "  âœ“ Connected:  $tsIP" -ForegroundColor Green
          } catch {
              Write-Error "Tailscale connection failed: $_"
              exit 1
          }

      - name: "ðŸ“‹ Display Connection Info"
        run: |
          Write-Host "`n" -ForegroundColor White
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘        ðŸš€ RDP CONNECTION INFORMATION ðŸš€                         â•‘" -ForegroundColor Cyan
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Cyan
          Write-Host "â•‘                                                                â•‘" -ForegroundColor Cyan
          Write-Host "â•‘  ðŸŒ Tailscale IP:     $env:TAILSCALE_IP" -ForegroundColor Green
          Write-Host "â•‘  ðŸ‘¤ Username:       RDP" -ForegroundColor Green
          Write-Host "â•‘  ðŸ”‘ Password:       $env:RDP_PASSWORD" -ForegroundColor Yellow
          if ($env:DATA_DRIVE) {
              Write-Host "â•‘  ðŸ’¾ Storage:        $env:DATA_DRIVE ($env:STORAGE_SIZE GB)" -ForegroundColor Green
          }
          Write-Host "â•‘  âš™ï¸  Mode:           $env:PERF_MODE" -ForegroundColor Cyan
          Write-Host "â•‘                                                                â•‘" -ForegroundColor Cyan
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Cyan
          Write-Host "â•‘  ðŸ“¢ AUDIO SETUP                                                â•‘" -ForegroundColor Magenta
          Write-Host "â•‘  RDP Client > Local Resources > Remote Audio >                 â•‘" -ForegroundColor Gray
          Write-Host "â•‘  Play on this computer                                         â•‘" -ForegroundColor Gray
          Write-Host "â•‘                                                                â•‘" -ForegroundColor Magenta
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Cyan
          Write-Host "â•‘  âœ¨ OPTIMIZATIONS APPLIED                                      â•‘" -ForegroundColor Green
          Write-Host "â•‘  âœ“ CPU Performance      âœ“ Memory Optimization                  â•‘" -ForegroundColor Gray
          Write-Host "â•‘  âœ“ Network Stack       âœ“ GPU Acceleration                      â•‘" -ForegroundColor Gray
          Write-Host "â•‘  âœ“ Jumbo Frames        âœ“ TCP Offloading                        â•‘" -ForegroundColor Gray
          Write-Host "â•‘  âœ“ QoS Priority        âœ“ Multi-Monitor                         â•‘" -ForegroundColor Gray
          Write-Host "â•‘                                                                â•‘" -ForegroundColor Green
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host "`n" -ForegroundColor White

      - name: "â³ System Monitor & Keep-Alive"
        run: |
          Write-Host "`nâ³ Starting monitoring..." -ForegroundColor Green
          
          $sessionActive = $true
          $checkInterval = 300
          $failureCount = 0
          
          while ($sessionActive) {
              try {
                  $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
                  
                  $tsStatus = & "$env:ProgramFiles\Tailscale\tailscale.exe" status 2>$null | Select-Object -First 1
                  if ($tsStatus -match "Connected") {
                      Write-Host "[$timestamp] âœ… Tailscale Connected" -ForegroundColor Green
                      $failureCount = 0
                  } else {
                      $failureCount++
                      Write-Host "[$timestamp] âš  Tailscale Disconnected ($failureCount/3)" -ForegroundColor Yellow
                      if ($failureCount -ge 3) {
                          & "$env:ProgramFiles\Tailscale\tailscale. exe" up --accept-routes --accept-dns=false
                          $failureCount = 0
                      }
                  }
                  
                  $cpuUsage = (Get-WmiObject -Query "SELECT LoadPercentage FROM Win32_Processor" | Measure-Object -Property LoadPercentage -Average).Average
                  $totalMem = (Get-WmiObject -Class Win32_ComputerSystem).TotalPhysicalMemory / 1GB
                  $freeMem = (Get-WmiObject -Class Win32_OperatingSystem).FreePhysicalMemory / 1MB / 1024
                  $memUsage = [math]::Round((($totalMem - $freeMem) / $totalMem) * 100)
                  
                  Write-Host "[$timestamp] CPU: $([math]::Round($cpuUsage))% | RAM: $memUsage% | Free: $([math]::Round($freeMem))GB" -ForegroundColor Cyan
                  
                  $rdpService = Get-Service -Name TermService -ErrorAction SilentlyContinue
                  if ($rdpService. Status -ne "Running") {
                      Start-Service -Name TermService -ErrorAction SilentlyContinue
                  }
                  
                  Start-Sleep -Seconds $checkInterval
              } catch {
                  Write-Host "[$timestamp] Error:  $_" -ForegroundColor Red
                  Start-Sleep -Seconds 60
              }
          }
