name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Configure RDP & Enable Remote Audio + Optimizations
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Restart-Service -Name TermService -Force

      - name: Create Strong RDP User
        run: |
          $passwordChars = @()
          $charSet = @{ Upper='A'..'Z'; Lower='a'..'z'; Number='0'..'9'; Special='!@#$%^&*()-_=+[]{}|;:,.<>?' }
          foreach ($set in $charSet.Values) { $passwordChars += $set | Get-Random -Count 12 }
          $password = -join ($passwordChars | Get-Random -Count 48)
          
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires -PasswordNeverExpires:$true
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
          
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV

      - name: Create Extra Drive X
        run: |
          $vhdxPath = "D:\extra_drive.vhdx"
          New-VHD -Path $vhdxPath -SizeBytes 300GB -Dynamic | Mount-VHD -PassThru | Out-Null
          
          Get-Disk | Where-Object PartitionStyle -eq 'RAW' | 
            Initialize-Disk -PartitionStyle GPT -PassThru |
            New-Partition -AssignDriveLetter -UseMaximumSize |
            Format-Volume -FileSystem ReFS -NewFileSystemLabel "AndroidFastDrive" -Confirm:$false -Force
          
          $driveLetter = (Get-Partition -DiskNumber (Get-Disk | Where-Object OperationalStatus -eq 'Online' | Select-Object -Last 1).Number | Select-Object -Last 1).DriveLetter
          echo "EXTRA_DRIVE=${driveLetter}:" >> $env:GITHUB_ENV

      - name: Install Latest Android Studio 
        run: |
          $installerUrl = "https://redirector.gvt1.com/edgedl/android/studio/install/2025.2.2.7/android-studio-2025.2.2.7-windows.exe"
          $installerPath = "$env:TEMP\android-studio.exe"
          Invoke-WebRequest -Uri $installerUrl -OutFile $installerPath
          
          Start-Process $installerPath -ArgumentList "/S", "/D=D:\Android\AndroidStudio" -Wait
          Remove-Item $installerPath -Force

      - name: Install SDK Packages & Auto Accept Licenses
        run: |
          $sdkManager = "D:\Android\AndroidStudio\android\sdk\cmdline-tools\latest\bin\sdkmanager.bat"
          $sdkRoot = "D:\Android\sdk"
          
      - name: Install Latest Tailscale
        run: |
          $stablePage = Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/" -UseBasicParsing
          $msiUrl = ($stablePage.Links | Where-Object { $_.href -like "*amd64.msi" } | Select-Object -First 1).href
          if (-not $msiUrl.StartsWith("http")) { $msiUrl = "https://pkgs.tailscale.com/stable/$msiUrl" }
          
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $msiUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Setup Tailscale-Only Firewall
        run: |
          netsh advfirewall firewall delete rule name="RDP-Tailscale" | Out-Null
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389 remoteip=100.64.0.0/10

      - name: Connect Tailscale
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-android-sound-${{ github.run_id }} --accept-routes --accept-dns=false
          
          $retries = 0
          do {
              Start-Sleep -Seconds 10
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              $retries++
          } while (-not $tsIP -and $retries -lt 30)
          
          if (-not $tsIP) { Write-Error "Không lấy được Tailscale IP."; exit 1 }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      

      - name: Run Keep-Alive
        run: |
          $script = @'
          while ($true) {
              $wsh = New-Object -ComObject WScript.Shell
              $wsh.SendKeys("{SCROLLLOCK}{SCROLLLOCK}")
              Start-Sleep -Seconds 30
          }
          '@
          Start-Process powershell -ArgumentList "-Command", $script -WindowStyle Hidden

      - name: Display Info & Keep Alive
        run:  | 
          

          Write-Host "Connect RDP: $env:TAILSCALE_IP"
          Write-Host "Username: RDP"
          Write-Host "Password: $env:RDP_PASSWORD"
          Write-Host "Tips SOUND: RDP client > Local Resources > Remote audio > Play on this computer"
          Write-Host "==================================`n"
          
          while ($true) {
              Write-Host "[$(Get-Date)] All systems active - No more license errors!"
              Start-Sleep -Seconds 600
          }
