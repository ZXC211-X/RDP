name: RDP

on:
  workflow_dispatch:

jobs:
  high-performance-rdp:
    runs-on: windows-latest
    timeout-minutes: 360 # Giới hạn thời gian tối đa (6 giờ)

    steps:
      # ----------------------------------------
      # 1. Cấu hình cốt lõi Remote Desktop (RDP)
      # ----------------------------------------
      - name: Configure RDP Settings
        run: |
          # Bật RDP và tắt tính năng Xác thực Cấp độ Mạng (NLA)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                            -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                            -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                            -Name "SecurityLayer" -Value 0 -Force
          
          # Cài đặt firewall để mở port RDP
          netsh advfirewall firewall delete rule name="RDP-Tailscale" || echo "No existing rule to delete."
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
          
          # Khởi động lại dịch vụ RDP
          Restart-Service -Name TermService -Force

      # ----------------------------------------
      # 2. Tạo người dùng RDP với mật khẩu bảo mật
      # ----------------------------------------
      - name: Create Secure RDP User
        run: |
          $password = (New-Object System.Random).Next(10000000,99999999) | ForEach-Object {$_ -join ((48..57) + (65..90) + (97..122) | Get-Random -Count 12 | ForEach-Object {[char]$_})}
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force

          New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"

          Write-Output "RDP_CREDS=User: RDP | Password: $password" >> $env:GITHUB_ENV

      # ------------------------------------------------
      # 3. Cài đặt và cấu hình Tailscale
      # ------------------------------------------------
      - name: Install Tailscale
        run: |
          $tsInstaller = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.msi" -OutFile $tsInstaller
          Start-Process msiexec.exe -ArgumentList "/i", "`"$tsInstaller`"", "/quiet", "/norestart" -Wait
          Remove-Item $tsInstaller -Force

      - name: Start and Authenticate Tailscale
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="gh-runner-${{ github.run_id }}"
          $retries = 0
          $ips = $null
          while (-not $ips -and $retries -lt 6) {
              $ips = (& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4)
              Start-Sleep -Seconds 10
              $retries++
          }
          if (-not $ips) {
              Write-Error "Failed to retrieve Tailscale IP."
              exit 1
          }
          Write-Output "TAILSCALE_IP=$ips" >> $env:GITHUB_ENV

      # --------------------------------------------
      # 4. Đảm bảo tốc độ mượt mà 60 FPS
      # --------------------------------------------
      - name: Enable Maximum GPU/CPU Performance
        run: |
          # Windows tự động quản lý GPU và hiệu suất tối đa, không cần cấu hình riêng nếu sử dụng phiên bản Windows-latest của GitHub.
          Write-Host "System operating at maximum default settings for GitHub runners."

      # --------------------------------------------
      # 5. Kiểm tra khả năng kết nói tới RDP
      # --------------------------------------------
      - name: Test RDP Connection
        run: |
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389
          if (-not $testResult.TcpTestSucceeded) {
              Write-Error "Failed to connect to remote desktop port."
              exit 1
          }
          
      # --------------------------------------------
      # 6. Giữ kết nối luôn hoạt động
      # --------------------------------------------
      - name: Keep Connection Alive
        run: |
          Write-Host "`n========== RDP INFO =========="
          Write-Host "Address: $env:TAILSCALE_IP"
          Write-Host "Username: RDP"
          Write-Host "Password: $($env:RDP_CREDS)"
          Write-Host "==============================="

          while ($true) {
              Write-Host "[$(Get-Date)] RDP Active... Terminate workflow to stop manually."
              Start-Sleep -Seconds 300
          }

      # -------------------------------------------------
      # 7. Cleanup - Xoá dữ liệu sau khi hoàn thành
      # -------------------------------------------------
      - name: Cleanup Temporary Resources
        if: always() # Luôn chạy cleanup dù workflow thành công hoặc thất bại
        run: |
          net user RDP /delete
          rm -Recurse -Force "$env:USERPROFILE\Desktop\*" 2>$null
          Write-Host "Temporary files removed successfully."